# {{ ansible_managed }}
---
version: "3"

networks:
  resolver-internal:
    driver: bridge
    ipam:
      config:
        - subnet: "192.168.48.0/29" # static network configuration needed since bind9 upstream can't be a hostname
          gateway: "192.168.48.1"
{% if activate_webinterfaces %}
  resolver-external:
    driver: bridge
{% endif %}

services:
  bind9:
    container_name: bind9
    image: cytopia/bind:0.35
    environment:
      - DNS_FORWARDER=192.168.48.3 # use Pi-hole as upstream
{% set a_records = ['ns.' ~ dns_zone ~ '=' ~ ansible_facts['default_ipv4']['address']] %}
{% if activate_webinterfaces %}
{% if activate_traefik_dashboard %}
{% set null = a_records.append('traefik.ns.' ~ dns_zone ~ '=' ~ ansible_facts['default_ipv4']['address']) %}
{% endif %}
{% if activate_pihole_webgui %}
{% set null = a_records.append('pihole.ns.' ~ dns_zone ~ '=' ~ ansible_facts['default_ipv4']['address']) %}
{% endif %}
{% endif %}
{% for host in hosts %}
{% set null = a_records.append(host['name'] ~ '.' ~ dns_zone ~ '=' ~ host['addr']) %}
{% endfor %}
{% for record in additional_a_records|default([]) %}
{% set null = a_records.append(record) %}
{% endfor %}
      - DNS_A={{ a_records|join(', ') }}
{% set ptr_records = [ansible_facts['default_ipv4']['address'] ~ '=' ~ 'ns.' ~ dns_zone] %}
{% for host in hosts %}
{% if '*' not in host['name'] %}
{% set null = ptr_records.append(host['addr'] ~ '=' ~ host['name'] ~ '.' ~ dns_zone) %}
{% endif %}
{% endfor %}
      - DNS_PTR={{ ptr_records|join(', ') }}
{% if cname_records|default([])|length > 0 %}
      - DNS_CNAME={{ cname_records|join(', ') }}
{% endif %}
      - ALLOW_QUERY={{ allowed_clients }}
    ports:
      - "53:53/tcp"
      - "53:53/udp"
    networks:
      resolver-internal:
        ipv4_address: "192.168.48.2"
    restart: unless-stopped
  pihole:
    container_name: pihole
    image: pihole/pihole:2023.03.1
{% if activate_webinterfaces %}
{% if activate_pihole_webgui %}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pihole.rule=Host(`pihole.ns.{{ dns_zone }}`)"
      - "traefik.http.routers.pihole.entrypoints=web"
      - "traefik.http.routers.pihole.service=pihole" # manual service config to address the correct port
      - "traefik.http.services.pihole.loadbalancer.server.port=80"
{% endif %}
{% endif %}
    environment:
{% if activate_webinterfaces %}
{% if activate_pihole_webgui %}
      WEBPASSWORD: Changeme01 #ToDo: parameterize
      VIRTUAL_HOST: "pihole.ns.{{ dns_zone }}"
{% endif %}
{% endif %}
      PIHOLE_DNS_: "1.1.1.1#53" # temporary cloudflare upstream
      WEBTHEME: default-dark
      DNSMASQ_LISTENING: local
      FTLCONF_LOCAL_IPV4: "{{ ansible_facts['default_ipv4']['address'] }}"
      FTLCONF_BLOCK_ICLOUD_PR: "true" # prevent Apple devices from bypassing Pi-hole https://docs.pi-hole.net/ftldns/configfile/#icloud_private_relay
      FTLCONF_MOZILLA_CANARY: "true" # prevent Firefox from bypassing Pi-hole https://docs.pi-hole.net/ftldns/configfile/#mozilla_canary
      FTLCONF_PIHOLE_PTR: NONE
    networks:
{% if activate_webinterfaces %}
{% if activate_pihole_webgui %}
      resolver-external:
{% endif %}
{% endif %}
      resolver-internal:
        ipv4_address: "192.168.48.3"
    volumes:
      - './pihole/etc:/etc/pihole'
      - './pihole/dnsmasq:/etc/dnsmasq.d'
    restart: unless-stopped
{% if activate_webinterfaces %}
  traefik:
    image: "traefik:v2.10"
    container_name: "traefik"
    command:
{% if activate_traefik_dashboard %}
      - "--api.dashboard=true"
      # ToDo: implement auth
{% endif %}
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=resolver-external"
      - "--entrypoints.web.address=:80"
      # ToDo: implement optional HTTPS
    labels:
      - "traefik.http.routers.dashboard.rule=Host(`traefik.ns.{{ dns_zone }}`) && PathPrefix(`/`)"
      - "traefik.http.routers.dashboard.service=dashboard@internal"
      - "traefik.http.routers.dashboard.entrypoints=web"
{% if activate_traefik_dashboard %}
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`traefik.ns.{{ dns_zone }}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.api.service=api@internal"
      - "traefik.http.routers.api.entrypoints=web"
{% endif %}
    ports:
      - "80:80"
    networks:
      resolver-external:
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
{% if activate_record_list_service %}
  record-service:
    image: nginx:1.24.0
    container_name: record-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.record-service.rule=Host(`ns.{{ dns_zone }}`)"
      - "traefik.http.routers.record-service.entrypoints=web"
    networks:
      resolver-external:
    volumes:
      - ./record-service/www:/usr/share/nginx/html
      - ./record-service/config/yaml-mime-type.conf:/etc/nginx/conf.d/yaml-mime-type.conf:ro
{% endif %}
{% endif %}
